<article>
    <h2 id="service-object-pattern">Service Object Pattern</h2>
    <p>
        Recently, I needed to add a new tiny authorization feature to the controllers of a Laravel application<label for="sn-27" class="sidenote-toggle sidenote-number"></label><input type="checkbox" id="sn-27" class="sidenote-toggle">
        <span class="sidenote">
            I never understood the PHP bashing but hey I'm not a software engineering so I'll my mouth shut.
        </span>. And since I was adding new stuff, the rule was: whatever I touch, if it's awful, refactor it first. I follow rules until I break them. In this case, the rule was a good rule.
    </p>

    <p>
        So I dived in. and I found something like as follows:
    </p>

    <div style="background: #272822; overflow:auto;width:auto;color:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <pre style="background-color:transparent;margin: 0; line-height: 125%"><span style="color: #66d9ef">public</span> <span style="color: #f8f8f2">function</span> <span style="color: #a6e22e">store</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Request</span> <span style="color: #f8f8f2">$request</span><span style="color: #f92672">)</span>
<span style="color: #f92672">{</span>
    <span style="color: #75715e">/*</span>
<span style="color: #75715e">     * a few lines</span>
<span style="color: #75715e">     */</span>

    <span style="color: #f8f8f2">$order</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">$this</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">createOrderAsSale</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">$request</span>);</span>
    <span style="color: #f8f8f2">$order</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">save</span><span style="color: #f92672">();</span>

    <span style="color: #75715e">/*</span>
<span style="color: #75715e">     * a few lines</span>
<span style="color: #75715e">     */</span>
<span style="color: #f92672">}</span>
        </pre>
    </div>

    <p>
        The function was ~40 lines in total. There were a couple refactors I did but for the purpose of this post, I'm focusing on <em>Service Object Pattern</em>. 
    </p>

    <p>
        The programmer who coded this was apparently a junior which it made sense since the code I saw<label for="sn-28" class="sidenote-toggle sidenote-number"></label><input type="checkbox" id="sn-28" class="sidenote-toggle">
        <span class="sidenote left">
            Well... I'm sure about that but complaining right now I find it unfair since he can't defend himself. Moving on.
        </span>. He decided to create a <em>Trait</em> and move the logic of <em>createOrderAsSale</em> in it. The controller was working just fine so my job was to add my authorization feature.
    </p>

    <p>
        I'm not an Laravel expert so I spent a few days learning the Laravel ways. The first thing I did was to change the function parameter to:
    </p>

    <div style="background: #272822; overflow:auto;width:auto;color:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <pre style="background-color:transparent;margin: 0; line-height: 125%"><span style="color: #66d9ef">public</span> <span style="color: #f8f8f2">function</span> <span style="color: #a6e22e">store</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">OrderStoreFormRequest</span> <span style="color: #f8f8f2">$request</span><span style="color: #f92672">)</span>
        </pre>
    </div>

    <p>
        Laravel recommends to add a <a href="https://laravel.com/docs/8.x/validation#form-request-validation">form request</a> for complex validations. This, however, was a complex validation but I decided to 
        add the form request anyway since it has the <em>authorize</em> function in itself by default.
    </p>

    <p>
        After I added the form request, it was quite simple to integrate the authorization feature. I added it and now I have to add controller tests (there were none at that moment).
    </p>

    <p>
        The authorization feature had unit tests already in place. I just needed to add test for the controller store action since there was no controller test and I just added new lines of code (remember the rule).
        I knew the controller was doing already too much but I didn't think refactor a priority right now since I needed to deliver this authorization future. I changed my mind though once I tried to add unit tests for the controller store action.
    </p>

    <p>
        The controller should get a request and delegate whatever needs to be done to other classes/services. This wasn't the case. 
        Not only it was not the case but there was a trait and as far as I can tell we should add a Trait <em>if we find ourselves repeating a lot of functionality across many classes or 
            to encapsulate useful functionality that we can add to our classes on an as-needed basis</em>. Also, Traits suppose to be <em>use</em> inside a class.
    </p>

    <p>
        So, I thought of the current code base. I have a controller that gets a request and do stuff either on its own or through a trait that is used <b>only by this controller</b>.
        The trait basically takes information as add that information to a new record. After that, it returns the initialized that later the controller save on the database. Hmmm
    </p>

    <p>
        No, I told to myself. The trait makes no sense. It's not reusable. It does not do what it says it does namelich it does not <em>create an order as a sale</em>. 
        This needs to be updated, I decided.
    </p>

    <p>
        First, I got rid of the Trait and I chose a <em>service object pattern</em>. The class will have only one public function called <em>call</em>. 
        The function will be static. The name of the class will be <em>CreateOrder</em> and it can be used as follows:
    </p>

    <div style="background: #272822; overflow:auto;width:auto;color:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <pre style="background-color:transparent;margin: 0; line-height: 125%"><span style="color: #e6db74">CreateOrder</span><span style="color: #f8f8f2">::</span><span style="color: #e6db74">call</span><span style="color: #f8f8f2">($request)</span>
        </pre>
    </div>

    <p>
        That change made immediately easy to unit test the controller store action. I just needed to test the store action, mock the class <em>CreateOrder</em>, test for bad and good order creations and done. I can then add a unit test for the class
        <em>CreateOrder</em> later.
    </p>

    <p>
        I like very much the Service Object Pattern because the convention follows, I think, name the class by telling what it does.
    </p>

    <p>
        And we lowered the entropy bit...
    </p>
</article>

